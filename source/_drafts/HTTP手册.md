title: HTTP手册
date: 2017-12-22 17:33:46
tags:
- test

##我们的网络

根据Web浏览器地址栏中指定的URL，Web浏览器从Web服务器端获取文件资源(resource)等信息，从而显示出Web页面。像这种通过发送请求获取服务器资源的Web浏览器等，都可称为**客户端**(client)。

Web通过三方面构建：作为页面的文本标记语言HTML、作为文档传递协议的HTTP、指定文档所在地址的URL，完成从客户端到服务器端等一系列运作流程。

> **超文本**（英语：**Hypertext**）是一种在电脑显示器或其他电子设备，用以显示文本及与文本相关的内容，其中的文字包含有可以链接到其他字段或者文档的超链接，允许从当前阅读位置直接切换到超链接所指向的文字。

借助多文档之间相互关联形成的**超文本**(HyperText)，连成可互相参阅的WWW(World Wide Web，万维网)。超文本是用超链接的方法，将各种不同空间的文字信息组织在一起的网状文本。超文本更是一种用户界面范式，用以显示文本及与文本之间相关的内容。

现时超文本普遍以电子文档方式存在，其中的文字包含有可链结到其他位置或者文档的连结，允许从当前阅读位置直接切换到超文本连结所指向的位置。超文本的格式有很多，目前最常使用的是超文本标记语言及富文本格式。

> **万维网**（英语：*World Wide Web*），亦作“WWW”、“Web”，是一个由许多互相链接的超文本组成的系统，通过互联网访问。
>
> 万维网是信息时代发展的核心，也是数十亿人在互联网上进行交互的主要工具。网页主要是文本文件格式化和超文本标记语言（HTML）。除了格式化文字之外，网页还可能包含图片、视频、声音和软件组件，这些组件会在用户的网页浏览器中呈现为多媒体内容的连贯页面。

超文本的聚集连接成了万维网，而同样以类似标准构建的网络互相关联便形成了庞大的互联网。

> **互联网**或**国际网**（英语： The Internet），是网络与网络之间所串连成的庞大网络，这些网络以一组标准的网络TCP/IP协议族相连，连接全世界几十亿个设备，形成逻辑上的单一巨大国际网络。它是由从地方到全球范围内几百万个私人的、学术界的、企业的和政府的网络所构成，通过电子，无线和光纤网络技术等等一系列广泛的技术联系在一起。这种将计算机网络互相联接在一起的方法可称作“网络互联”，在这基础上发展出覆盖全世界的全球性互联网络称互联网，即是互相连接一起的网络。
>
> 互联网并不等同万维网（WWW），万维网只是一个基于超文本相互链接而成的全球性系统，且是互联网所能提供的服务其中之一。互联网带有范围广泛的信息资源和服务，例如相互关系的超文本文件，还有万维网的应用，支持电子邮件的基础设施，对等式网络，文件共享，以及网络协议通话技术。

## 它是如何传输的

计算机与网络设备要互相通信，双方就必须基于相同的方法。比如，如何探测到通信目标、由哪一边先发起通信、使用哪种语言进行通信、怎样结束通信等规则都需要事先确定。不同的硬件、操作系统之间的通信，所有的这一切都需要事先确定，都需要一种规则。而我们就把这种规则称为协议(protocol)。

协议中存在各式各样的内容。从电缆的规格到IP地址的选定方法、寻找异地用户的方法、双方建立通信的顺序，以及Web页面显示需要处理的步骤，等等。像这样把与互联网相关联的协议集合起来总称为TCP/IP。

> **互联网协议族**（英语：Internet Protocol Suite，缩写IPS）是一个网络通信模型，以及一整个网络传输协议家族，为互联网的基础通信架构。
>
> 它常被通称为**TCP/IP协议族**（英语：TCP/IP Protocol Suite，或TCP/IP Protocols），简称**TCP/IP**。因为该协议家族的两个核心协议：TCP（传输控制协议）和IP（网际协议），为该家族中最早通过的标准。
>
> 由于在网络通讯协议普遍采用分层的结构，当多个层次的协议共同工作时，类似计算机科学中的堆栈，因此又被称为**TCP/IP协议栈**（英语：TCP/IP Protocol Stack）。
>
> 这些协议最早发源于美国国防部（缩写为DoD）的ARPA网项目，因此也被称作**DoD模型**（DoD Model）。

整个通信网络的任务，可以划分成不同的功能区块，即所谓的层级。所有这些协议都在相应的RFC文档中讨论及标准化。早期OSI模型

|      | 数据单元         | OSI模型 | TCP/IP参考模型 | 功能                                       |
| ---- | ------------ | ----- | ---------- | ---------------------------------------- |
| 主机层  | 数据(Data)     | 应用层   | 应用层        | 提供为应用软件而设的界面，以设置与另一应用软件之间的通信。例如: HTTP，HTTPS，FTP，TELNET，SSH，SMTP，POP3等。 |
| 主机层  | 数据(Data)     | 表示层   | 应用层        | 把数据转换为能与接收者的系统格式兼容并适合传输的格式。              |
| 主机层  | 数据(Data)     | 会话层   | 应用层        | 负责在数据传输中设置和维护电脑网络中两台电脑之间的通信连接。           |
| 主机层  | 数据段(Segment) | 传输层   | 传输层        | 把传输表头（TH）加至数据以形成数据包。传输表头包含了所使用的协议等发送信息。例如:传输控制协议（TCP）等。 |
| 媒介层  | 数据包(Packet)  | 网络层   | 网络互连层      | 决定数据的路径选择和转寄，将网络表头（NH）加至数据包，以形成分组。网络表头包含了网络数据。例如:互联网协议（IP）等。 |
| 媒介层  | 数据帧(Frame)   | 数据链路层 | 网络接口层      | 数据链路层（Data Link Layer）负责网络寻址、错误侦测和改错。当表头和表尾被加至数据包时，会形成帧。例如以太网、无线局域网（Wi-Fi）和通用分组无线服务（GPRS）等。 |
| 媒介层  | 比特(Bit)      | 物理层   | 网络接口层      | 在局部局域网上传送帧，它负责管理电脑通信设备和网络媒体之间的互通。包括了针脚、电压、线缆规范、集线器、中继器、网卡、主机适配器等 |

**TCP/IP参考模型**

**应用层** (application layer)：该层包括所有和应用程序协同工作，利用基础网络交换应用程序专用的数据的协议。 

**传输层** (transport layer)：传输层对上层应用层，提供处于网络连接中的两台计算机之间的数据传输。

**网络互连层** (internet layer)：网络层规定了通过怎样的传输路线到达对方计算机，并把数据包传送给对方。即寻址。

**网络接口层** (link layer)：用来处理连接网络的硬件部分。

利用TCP/IP协议族进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，接收端则往应用层往上走。

## 具体实现

### HTTP

> HTTP是一个客户端终端（用户）和服务器端（网站）请求和应答的标准（TCP）。通过使用网页浏览器、网络爬虫或者其它的工具，客户端发起一个HTTP请求到服务器上指定端口（默认端口为80）。我们称这个客户端为用户代理程序（user agent）。应答的服务器上存储着一些资源，比如HTML文件和图像。我们称这个应答服务器为源服务器（origin server）。在用户代理和源服务器中间可能存在多个“中间层”，比如代理服务器或者隧道（tunnel）。
>
> 尽管TCP/IP协议是互联网上最流行的应用，HTTP协议中，并没有规定必须使用它或它支持的层。事实上，HTTP可以在任何互联网协议上，或其他网络上实现。HTTP假定其下层协议提供可靠的传输。因此，任何能够提供这种保证的协议都可以被其使用。因此也就是其在TCP/IP协议族使用TCP作为其传输层。
>
> 通常，由HTTP客户端发起一个请求，创建一个到服务器指定端口（默认是80端口）的TCP连接。HTTP服务器则在那个端口监听客户端的请求。一旦收到请求，服务器会向客户端返回一个状态，比如"HTTP/1.1 200 OK"，以及返回的内容，如请求的文件、错误消息、或者其它信息。

具体表现形式为：

```http
客户端
GET / HTTP/1.1
Host: github.com
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.8
Cookie: ......

```

```http
服务器
HTTP/1.1 200 OK
Date: Thu, 21 Dec 2017 11:41:36 GMT
Content-Type: text/html; charset=utf-8
Transfer-Encoding: chunked
Server: GitHub.com
Status: 200 OK
Cache-Control: no-cache
Vary: X-PJAX
X-UA-Compatible: IE=Edge,chrome=1
Set-Cookie: ......

（紧跟着一个空行，并且由HTML格式的文本组成了Google的主页）
```

**请求报文** 由请求方法、请求URI、协议版本、请求首部字段(可选)和内容实体(可选)。

**响应报文** 由协议版本、状态码、状态码原因短语、响应首部字段(可选)和内容实体(可选)。

那应该如何获取请求地址的资源呢？这里就是HTTP的方法了。

- 副作用：任意多次对同一资源操作，都不会导致资源的状态变化
- 幂等性：任意次对同一资源操作，对资源的改变是一样的

| Method | 安全性  | 幂等性  | 说明                            |
| ------ | :--: | :--: | ----------------------------- |
| GET    |  √   |  √   | 向指定资源发出"显示"请求，一般是查询资源。        |
| POST   |  ×   |  ×   | 向指定资源提交数据，请求服务器进行处理。可创建和更新资源。 |
| PUT    |  ×   |  √   | 向指定资源位置上传其最新内容，即替换资源。         |
| PATCH  |  ×   |  √   | 将局部修改应用到资源。                   |
| DELETE |  ×   |  √   | 请求服务器删除所标识的资源。                |

主要区分GET和POST的区别：

|           | GET                                      | POST                                     |
| --------- | ---------------------------------------- | ---------------------------------------- |
| 返回按钮/重新加载 | 无副作用                                     | 数据将被重新提交(浏览器应该提醒用户数据即将被重新提交)             |
| 书签        | 可以加书签                                    | 不可以加书签                                   |
| 缓存        | 可以被缓存                                    | 不可以被缓存                                   |
| 编码类型      | application/x-www-form-urlencoded只能进行url编码 | application/x-www-form-urlencoded or multipart/form-data.用multipart对二进制数据进行编码。支持多种编码方式 |
| 历史记录      | 参数保留在浏览器历史记录中                            | 参数不保留在浏览器历史记录中                           |
| 限制数据长度    | 是的，在发送数据时，GET方法将数据添加到URL; 而URL的长度是有限的（最大URL长度是2048个字符） | 对数据长度没有限制                                |
| 限制数据类型    | 只允许ASCII码                                | 对数据类型没有限制，二进制数据也是可以使用的。                  |
| 安全性       | 与POST相比，GET的安全性较低，因为发送的数据是URL的一部分。发送密码或其他敏感信息时切勿使用GET！ | POST比GET更安全，因为这些参数不存储在浏览器历史记录或Web服务器日志中  |
| 能见度       | 所有人都可以在URL中读到数据                          | 数据不会显示在URL中                              |

状态码：

所有HTTP响应的第一行都是**状态行**，依次是当前HTTP版本号，3位数字组成的状态代码，以及描述状态的短语，彼此由空格分隔。

状态代码的第一个数字代表当前响应的类型：

- 1xx消息——请求已被服务器接收，继续处理
- 2xx成功——请求已成功被服务器接收、理解、并接受
- 3xx重定向——需要后续操作才能完成这一请求
- 4xx请求错误——请求含有词法错误或者无法被执行
- 5xx服务器错误——服务器在处理某个正确请求时发生错误

虽然 RFC 2616中已经推荐了描述状态的短语，例如"200 OK"，"404 Not Found"，但是WEB开发者仍然能够自行决定采用何种短语，用以显示本地化的状态描述或者自定义信息。

#### cookie

因为HTTP协议是无状态的，即服务器不知道用户上一次做了什么，这严重阻碍了交互式Web应用程序的实现。在典型的网上购物场景中，用户浏览了几个页面，买了一盒饼干和两瓶饮料。最后结帐时，由于HTTP的无状态性，不通过额外的手段，服务器并不知道用户到底买了什么，所以Cookie就是用来绕开HTTP的无状态性的“额外手段”之一。服务器可以设置或读取Cookies中包含信息，借此维护用户跟服务器会话中的状态。

**会话**（**session**）是一种持久网络协议，在用户（或用户代理）端和服务器端之间创建关联，从而起到交换数据包的作用机制。



### TCP

> TCP是一种面向连接的、可靠的、基于字节流的传输层通信协议
>
> 在因特网协议族（Internet protocol suite）中，TCP层是位于IP层之上，应用层之下的中间层。不同主机的应用层之间经常需要可靠的、像管道(Unix))一样的连接，但是IP层不提供这样的流机制，而是提供不可靠的包交换。
>
> 应用层向TCP层发送用于网间传输的、用8位字节表示的数据流，然后TCP把数据流分区成适当长度的报文段（通常受该计算机连接的网络的数据链路层的最大传输单元（MTU）的限制）。之后TCP把结果包传给IP层，由它来通过网络将包传送给接收端实体的TCP层。TCP为了保证不发生丢包，就给每个包一个序号，同时序号也保证了传送到接收端实体的包的按序接收。然后接收端实体对已成功收到的包发回一个相应的确认（ACK）；如果发送端实体在合理的往返时延（RTT）内未收到确认，那么对应的数据包就被假设为已丢失将会被进行重传。TCP用一个校验和函数来检验数据是否有错误；在发送和接收时都要计算校验和。

TCP将大块数据分割成已报文段为单位的数据包，并给数据包提供可靠的传输服务。IP协议的作用是把各种数据包传送给对方。

三次握手

C(SYN)：洞拐洞拐，我是洞幺。这里有份急电要传给你。

S(SYN，ACK)：洞幺洞幺，我是洞拐。已确认可以接受电报。

C(ACK)：收到，OVER。着手发电报。

在握手过程中使用了TCP的标志(flag)——SYN(synchronize)和ACK(acknowledgement)。大致传输过程就是，发送端请求同步，接收端收到后返回接收同步并请发送端确认，最后发送端再回传确认则"握手"结束。若在握手过程中某个阶段莫名中断，TCP协议会再次以相同的顺序发送相同的数据包。

tips：

当客户端收到服务端的SYN+ACK应答后，其状态变为ESTABLISHED，并会发送ACK包给服务端，准备发送数据了。如果此时ACK在网络中丢失，过了超时计时器后，那么Server端会重新发送SYN+ACK包，重传次数根据/proc/sys/net/ipv4/tcp_synack_retries来指定，默认是5次。如果重传指定次数到了后，仍然未收到ACK应答，那么一段时间后，Server自动关闭这个连接。但是Client认为这个连接已经建立，如果Client端向Server写数据，Server端将以RST包响应，方能感知到Server的错误。

四次挥手

ESTABLISHED

C(FIN)：电报发送完毕，请求关闭(等待回复FIN_WAIT_1)

S(ACK)：收到，需要确认信息是否传输完毕，请稍等。(确认数据传输完成CLOSE_WAIT)

S(FIN)：已确认可以关闭(等待确认LAST_ACK)

C(ACK)：收到，OVER。(完成关闭TIME_WAIT)

CLOSED



### IP

> 任务是仅仅根据源主机和目的主机的地址传送数据。为此目的，IP定义了寻址方法和数据报的封装结构。
>
> **IP地址**（英语：IP Address），是分配给网络上使用网际协议（英语：Internet Protocol, IP）的设备的数字标签。常见的IP地址分为IPv4与IPv6两大类。

#### 域名系统DNS

我们很难通过输入一组纯数字来区分需要访问的IP地址，所以就有了方便人类记忆的域名(由字母搭配数字)。可计算机不擅长处理名称，这就需要有域名到IP地址之间的解析服务，即DNS。这样我们只需要输入易于记忆的域名，然后通过DNS解析为IP地址进行访问。

tips:www.作为域名前缀起到主域名与子域名区分的作用

域名划分：

.com 顶级域名

baidu.com 一级域名

www.baidu.com 二级域名

bbs.baidu .com 二级域名

tieba.baidu .com 二级域名

#### 统一资源标志符

可如果访问地址数据量大、资源丰富的话，我们该如何去取到想要的资源呢？这便是URI(统一资源标识符)的作用了。

> URI可被视为定位符（URL），名称（URN）或两者兼备。统一资源名（URN）如同一个人的名称，而统一资源定位符（URL）代表一个人的住址。换言之，URN定义某事物的身份，而URL提供查找该事物的方法。
>
> 用于标识唯一书目的ISBN系统是一个典型的URN使用范例。例如，ISBN 0-486-27557-4( <urn:ISBN> 0-486-27557-4 )无二义性地标识出莎士比亚的戏剧《罗密欧与朱丽叶》的某一特定版本。为获得该资源并阅读该书，人们需要它的位置，也就是一个URL地址。在类Unix操作系统中，一个典型的URL地址可能是一个文件目录，例如file:///home/username/RomeoAndJuliet.pdf。该URL标识出存储于本地硬盘中的电子书文件。因此，URL和URN有着互补的作用。

我们在浏览器上输入的网址具体解析如下：

| http:// | user:passwd | www.example.com | :80    | /dir/index.html | ?uid=1 |
| ------- | ----------- | --------------- | ------ | --------------- | ------ |
| 协议名     | 认证信息(可选)    | 服务器地址           | 服务器端口号 | 文件路径            | 查询字符串  |



tips:**格式化文本**与纯文本相对，具有风格、排版等信息，如颜色、式样(黑体、斜体等)、字体尺寸、特性(如超链接)等。

tips:**格式化**是指对磁盘或磁盘中的分区（partition）进行*初始化*的一种操作，这种操作通常会导致现有的磁盘或分区中所有的文件被清除。

tips:有些人往往会弄不清在计算机中出现的“位”和Byte,KB,MB等有何关系，而它们的关系是，8位等于一字节Byte，即8bit=1B 。32位处理器每次处理 4Byte(32bit)，同理，64位处理器每次处理 8Byte(64bit)

在 ASCII 编码中，一个英文字母字符存储需要1个字节。在 GB 2312 编码或 GBK 编码中，一个汉字字符存储需要2个字节。在UTF-8编码中，一个英文字母字符存储需要1个字节，一个汉字字符储存需要3到4个字节。

**无类别域间路由(CIDR)**是一个用于给用户分配IP地址以及在互联网上有效地路由IP数据包的对IP地址进行归类的方法。

IP地址分公网和内网，由**网络地址转换**(NAT)实现。